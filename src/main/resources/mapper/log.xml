<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.log">

    <select id="futureslogL" parameterType="Map" resultType="Map">
        select f.*, m.id id, m.name name, m.level level
            , CASE
                WHEN (m.parentsIdx = -1) THEN '본사'
                ELSE (select id from member p where p.idx = m.parentsIdx)
            END as parentId
        from futureslog f left join member m on m.idx = f.useridx
        where 1=1
            <if test="userIdx != null and userIdx != ''">
                and userIdx = #{userIdx}
            </if>
            <if test="parentsIdx != null and parentsIdx != ''">
                and m.parentsIdx = #{parentsIdx}
            </if>

            <if test="sdate != null and sdate != ''">
                and DATE(f.gdate) between #{sdate} and #{edate}
            </if>

            <if test="search != null and search != ''">
                <if test="searchSelect == 'm.parentsIdx'">
                    and ${searchSelect} = #{search}
                </if>
                <if test="searchSelect != 'm.parentsIdx'">
                    and ${searchSelect} like concat('%',#{search},'%')
                </if>
            </if>
        order by f.gdate desc
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>
    <select id="futureslogT" parameterType="Map" resultType="Integer">
        select count(*)
        from futureslog f left join member m on m.idx = f.useridx
        where 1=1
            <if test="userIdx != null and userIdx != ''">
                and userIdx = #{userIdx}
            </if>
            <if test="parentsIdx != null and parentsIdx != ''">
                and m.parentsIdx = #{parentsIdx}
            </if>

            <if test="sdate != null and sdate != ''">
                and DATE(f.gdate) between #{sdate} and #{edate}
            </if>

            <if test="search != null and search != ''">
                <if test="searchSelect == 'm.parentsIdx'">
                    and ${searchSelect} = #{search}
                </if>
                <if test="searchSelect != 'm.parentsIdx'">
                    and ${searchSelect} like concat('%',#{search},'%')
                </if>
            </if>
    </select>

    <insert id="insertFutureslog">        
        INSERT INTO futureslog( 
            userIdx
            , bf
            , af
            , futures
            , kind
            , gdate
    <if test="tradeDate != null and tradeDate != ''">
            , tradeDate
    </if>
        ) VALUES (
            #{userIdx} 
            , #{bf} 
            , #{af} 
            , #{futures} 
            , #{kind} 
            , #{gdate}
    <if test="tradeDate != null and tradeDate != ''">
            , #{tradeDate}
    </if>
        )
    </insert>
</mapper>