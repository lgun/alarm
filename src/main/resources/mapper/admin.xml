<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.admin">

    <select id="adminLogin" parameterType="Map" resultType="Map">
        SELECT *
        FROM admin
        where id=#{id} and pw=#{pw}
        limit 1
    </select> 

    <select id="selectAdmin" parameterType="Map" resultType="Map">
        SELECT id, inviteCode, telegram, chatName, chatEx, bank, name, account
        FROM admin
        limit 1
    </select>

    <update id="updateTelegram">
        update admin
        set telegram = #{telegram}
        limit 1
    </update>

    <update id="updateAccount">
        update admin
        set idx = 1
            <if test="bank != null and bank != '' and bank != 'null'">
                , bank = #{bank}
            </if>
            <if test="name != null and name != '' and name != 'null'">
                , name = #{name}
            </if>
            <if test="account != null and account != '' and account != 'null'">
                , account = #{account}
            </if>
    </update>

    <update id="updateChat">
        update admin
        set idx = 1
            <if test="chatName != null and chatName != '' and chatName != 'null'">
                , chatName = #{chatName}
            </if>
            <if test="ChatEx != null and ChatEx != '' and ChatEx != 'null'">
                , ChatEx = #{ChatEx}
            </if>
    </update>

    <!-- verificationlog -->
    <select id="selectVerificationCheck" parameterType="Map" resultType="Map">
        select v.*
        from verificationlog v 
        where v.userIdx = #{userIdx} and confirm = 0
        limit 1
    </select>
    <select id="selectVerificationDetail" parameterType="Map" resultType="Map">
        select v.*, m.name name, m.id id, m.level level, m.idx userIdx
        from verificationlog v inner JOIN member m ON m.idx = v.useridx
        where v.idx = #{idx}
            <if test="partnerIdx != null and partnerIdx != ''">
                and parentsIdx = #{partnerIdx}
            </if>
    </select>
    <select id="selectVerificationList" parameterType="Map" resultType="Map">
        select v.*, m.name name, m.id id, m.level level, m.idx userIdx
        from verificationlog v inner JOIN member m ON m.idx = v.useridx
        where 1=1
            <if test="partnerIdx != null and partnerIdx != ''">
                and parentsIdx = #{partnerIdx}
            </if>
            
             <if test="test != 'test'">
                and m.isTest != 1
            </if>
            <if test="search != null and search != ''">
                <if test="searchSelect == 'm.parentsIdx'">
                    and ${searchSelect} = #{search}
                </if>
                <if test="searchSelect != 'm.parentsIdx'">
                    and ${searchSelect} like concat('%',#{search},'%')
                </if>
            </if>
            <if test="type != null and type != ''">
                and v.type = #{type}
            </if>
            <if test="sdate != null and sdate != ''">
                and DATE(v.vdate) between #{sdate} and #{edate}
            </if>
            <if test="state != null and state != ''">
                and v.confirm = #{state}
            </if>
        order by v.vdate desc
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>
    <select id="selectVerificationCnt" parameterType="Map" resultType="Integer">
        select count(*)
        from verificationlog v inner JOIN member m ON m.idx = v.useridx
        where 1=1
            <if test="partnerIdx != null and partnerIdx != ''">
                and parentsIdx = #{partnerIdx}
            </if>

            <if test="test != 'test'">
                and m.isTest != 1
            </if>
            <if test="search != null and search != ''">
                <if test="searchSelect == 'm.parentsIdx'">
                    and ${searchSelect} = #{search}
                </if>
                <if test="searchSelect != 'm.parentsIdx'">
                    and ${searchSelect} like concat('%',#{search},'%')
                </if>
            </if>
            <if test="state != null and state != ''">
                and v.confirm = #{state}
            </if>
            <if test="type != null and type != ''">
                and v.type = #{type}
            </if>
            <if test="sdate != null and sdate != ''">
                and DATE(v.vdate) between #{sdate} and #{edate}
            </if>
             <if test="confirm != null and confirm != ''">
                and v.confirm = #{confirm}
            </if>
            <if test="alarm != null and alarm != ''">
                and v.alarm = #{alarm}
            </if>
    </select>

    <update id="updateVerification">
        update verificationlog 
        set idx=idx
        <if test="alarm != 'null' and alarm != null and alarm != ''">
                , alarm = #{alarm}
        </if>
        <if test="confirm != 'null' and confirm != '' and confirm != null">
                , confirm  = #{confirm}
                , confirmdate = now()
        </if>
        WHERE idx=#{idx}
            <if test="parentsIdx != null and parentsIdx != ''">
                and (select parentsIdx from member where member.idx=verificationlog.userIdx)=#{parentsIdx}
            </if>
    </update>

    <!-- aitrade -->
    <select id="selectAiTradeDetail" parameterType="Map" resultType="Map">
        select a.*
        from aitrade a 
        where a.idx = #{idx}
    </select>
    
    <update id="removeUpdateAiTrade">
        update aitrade 
        set state=-1
        WHERE idx=#{idx}
    </update>
     <update id="updateAiTrade">
        update aitrade 
        set idx=idx
        <if test="days != null and days != ''">
            , days = #{days}
        </if>
        <if test="minProfitRate != null and minProfitRate != ''">
            , minProfitRate = #{minProfitRate}
        </if>
        <if test="maxProfitRate != null and maxProfitRate != ''">
            , maxProfitRate = #{maxProfitRate}
        </if>
        <if test="showMinProfitRate != null and showMinProfitRate != ''">
            , showMinProfitRate = #{showMinProfitRate}
        </if>
        <if test="showMaxProfitRate != null and showMaxProfitRate != ''">
            , showMaxProfitRate = #{showMaxProfitRate}
        </if>
        <if test="minAmount != null and minAmount != ''">
            , minAmount = #{minAmount}
        </if>
        <if test="maxAmount != null and maxAmount != ''">
            , maxAmount = #{maxAmount}
        </if>
        WHERE idx=#{idx}  and state=0
    </update>

    <!-- aitradeData -->
     <select id="selectAiTradeRequestCnt" parameterType="Map" resultType="Integer">
        select count(*)
        from aitradeData a 
        where a.aiTradeIdx = #{idx}
        <![CDATA[
            and a.endDate > now()
        ]]>
    </select>
	
    <select id="selectAiTradeDataDetail" parameterType="Map" resultType="Map">
        select a.*, m.name name, m.id id, m.level level, m.idx userIdx ,ai.days,ai.coin ,ai.maxAmount ,ai.showMinProfitRate ,ai.showMaxProfitRate
        from aitradedata a 
            inner JOIN member m ON m.idx = a.useridx
            left JOIN aitrade ai ON ai.idx = a.aiTradeIdx
        where a.idx = #{idx}
            <if test="partnerIdx != null and partnerIdx != ''">
                and m.parentsIdx = #{partnerIdx}
            </if>
    </select>
    <select id="selectAiTradeDataList" parameterType="Map" resultType="Map">
        select a.*, m.name name, m.id id, m.level level, m.idx userIdx, ai.days,ai.coin, ai.showMinProfitRate, ai.showMaxProfitRate
        from aitradedata a 
            inner JOIN member m ON m.idx = a.useridx
            left JOIN aitrade ai ON ai.idx = a.aiTradeIdx
        where 1=1
            <if test="partnerIdx != null and partnerIdx != ''">
                and m.parentsIdx = #{partnerIdx}
            </if>

            <if test="state != null and state != ''">
                and a.state = #{state}
            </if>
            <if test="search != null and search != ''">
                and ${searchSelect} = #{search}
            </if>
            <if test="sdate != null and sdate != ''">
                and DATE(a.tdate) between #{sdate} and #{edate}
            </if>
             <if test="test != 'test'">
                and m.isTest != 1
            </if>
            <if test="search != null and search != ''">
                <if test="searchSelect == 'm.parentsIdx'">
                    and ${searchSelect} = #{search}
                </if>
                <if test="searchSelect != 'm.parentsIdx'">
                    and ${searchSelect} like concat('%',#{search},'%')
                </if>
            </if>
        order by a.tdate desc
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>
    <select id="selectAiTradeDataCnt" parameterType="Map" resultType="Integer">
        select count(*)
        from aitradedata a 
            inner JOIN member m ON m.idx = a.useridx
            left JOIN aitrade ai ON ai.idx = a.aiTradeIdx
        where 1=1
            <if test="partnerIdx != null and partnerIdx != ''">
                and m.parentsIdx = #{partnerIdx}
            </if>

            <if test="state != null and state != ''">
                and a.state = #{state}
            </if>
            <if test="search != null and search != ''">
                and ${searchSelect} = #{search}
            </if>
            <if test="sdate != null and sdate != ''">
                and DATE(a.tdate) between #{sdate} and #{edate}
            </if>
         <if test="userIdx != null and userIdx != ''">
                and a.userIdx = #{userIdx}
            </if>
            <if test="test != 'test'">
                and m.isTest != 1
            </if>

            <if test="search != null and search != ''">
                <if test="searchSelect == 'm.parentsIdx'">
                    and ${searchSelect} = #{search}
                </if>
                <if test="searchSelect != 'm.parentsIdx'">
                    and ${searchSelect} like concat('%',#{search},'%')
                </if>
            </if>
    </select>

    <!-- partners -->
    <select id="selectPartnersList" parameterType="Map" resultType="Map">
        SELECT *
        FROM partners
        where 1=1
        and isRemove = 0
    </select> 
    <select id="selectPartnersCnt" parameterType="Map" resultType="Integer">
        SELECT count(*)
        FROM partners
        where 1=1 
        and isRemove = 0
    </select> 
    
    <insert id="insertPartners">        
        INSERT INTO partners( 
            name
            , pdate
        ) VALUES (
             #{partnersName} 
            , now() 
        )
    </insert>
    <update id="removePartners">
            update partners
            set isRemove = 1
            WHERE idx=#{idx}
	</update>
    <select id="selectGuidePopup" parameterType="Map" resultType="Map">
        SELECT *
        FROM guidepopup
        where page=#{page}
        limit 1
    </select> 
    <update id="updateGuidePopup">
            update guidePopup
            set idx=idx
            <if test="img != null and img != ''">
                , img = #{img}
            </if>
            <if test="text != null and text != ''">
                , text = #{text}
            </if>
            <if test="isShow != null and isShow != ''">
                , isShow = #{isShow}
            </if>
            WHERE page=#{page}
	</update>
</mapper>